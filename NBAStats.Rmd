---
title: "GroupProject2"
author: "Miguel Bonilla, Jordan Eaddy, Milan Patel"
date: "7/21/2022"
always_allow_html: true
output:
  md_document:
    variant: markdown_github
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(GGally)
library(MASS)
library(caret)
library(glmnet)
library(kableExtra)
```

## load data
will clean and remove opposing team stats, since they're included as the primary on the mirror matchup (i.e. Atl-Tor, vs Tor-Atl)
also removing date, since Game is a better metric of when a game takes place in relation to the point of the season

### Variable Descriptions
* PTS - Team Points Scored
* FG - Field Goals Made
* FGA - Field Goals Attempted
* FG% - Field Goal Percentage
* 3P - Three Points Made
* 3PA - Three Points Attempted
* 3P% - Three Point Percentage
* FT - Free Throws Made
* FTA - Free Throws Attempted
* FT% - Free Throw Percentage
* ORB - Offensive Rebounds
* TRB - Total Rebounds
* AST - Assists
* STL - Steals
* BLK - Blocks
* TOV - Turnovers
* PF - Fouls

```{r}
rawdata <- read.csv("https://raw.githubusercontent.com/boneeyah/GroupProject2/main/DataFile/nba.games.stats.csv")
cleandata <- rawdata[,c(7,3,5,8,10:25)] #rearrange to leave W/L first

str(cleandata) #check variable type

cleandata %>% count(WINorLOSS) %>% ggplot(aes(x=WINorLOSS, y= n, fill = WINorLOSS))+geom_bar(stat = "identity") 
#data is perfectly balanced, becasue for each win on the data set there is an opposing team who lost and vice-versa

#set categorical variables to factors
cleandata$WINorLOSS <- as.factor(cleandata$WINorLOSS)
cleandata$Home <- as.factor(cleandata$Home)

##change variable names
cleandata <- rename(cleandata, c("PTS" = TeamPoints, "FG"=FieldGoals,"FGA"=FieldGoalsAttempted, "FG%"=FieldGoals., "3PA"=X3PointShotsAttempted, "3P" = X3PointShots, "3P%"=X3PointShots.,"FT"=FreeThrows, "FTA"=FreeThrowsAttempted, "FT%"=FreeThrows.,"ORB"=OffRebounds,"TRB"=TotalRebounds, "AST"=Assists, "STL"=Steals,"BLK"=Blocks,"TOV"=Turnovers, "PF"=TotalFouls))

sapply(cleandata, function(x) sum(is.na(x))) #no NAs present

ggpairs(cleandata, columns = 2:10, aes(color = WINorLOSS))
ggpairs(cleandata, columns = 11:20, aes(color = WINorLOSS))

```
There is a separation between home and away
also for team points, field goals, field goal %, 3 point shots and 3 point shot %
to a lesser extent, total rebounds, assists, and turnovers
```{r}
plot(WINorLOSS~Home, col = c("#F8766D","#00bfc4"), data = cleandata)
plot(PTS~WINorLOSS, col = c("#F8766D","#00bfc4"), data = cleandata)
plot(`FG%`~WINorLOSS, col = c("#F8766D","#00bfc4"), data = cleandata)
plot(FG~WINorLOSS, col = c("#F8766D","#00bfc4"), data = cleandata)
plot(`3PA`~WINorLOSS, col = c("#F8766D","#00bfc4"), data = cleandata)
plot(`3P%`~WINorLOSS, col = c("#F8766D","#00bfc4"), data = cleandata)
plot(TRB~WINorLOSS, col = c("#F8766D","#00bfc4"), data = cleandata)
plot(AST~WINorLOSS, col = c("#F8766D","#00bfc4"), data = cleandata)
```
##correlation plot
build a heatmap to check for correlation between explanatory variables
```{r}
library(lattice)
library(reshape2)
library(ggthemes)
cleandata.corr <- round(cor(cleandata[,c(2,4:20)]),2)
cleandata.corr <- melt(cleandata.corr)

cleandata.corr %>% ggplot(aes(x=Var1, y=Var2, fill=value))+geom_tile()+scale_fill_viridis_c()+theme(axis.title.x = element_blank(),axis.title.y = element_blank())
```

```{r}
#set seed
set.seed(1726)#8721
##80-20 split of data
index <- sample(nrow(cleandata), round(.8*nrow(cleandata)))
train <- cleandata[index,]
test <- cleandata[-index,]


simple.mod <- glm(WINorLOSS~ Home + PTS + `FG%` + TRB, family = "binomial", data=train)
coef(simple.mod)
summary(simple.mod)

simple.pred <- predict(simple.mod, newdata = test, type = "response")
simple.pred <- ifelse(simple.pred > .5, "W", "L")
simple.pred <- factor(simple.pred, levels = c("W","L"))
test$WINorLOSS <- factor(test$WINorLOSS, levels = c("W", "L"))


cm.simple <- confusionMatrix(data =simple.pred, reference = test$WINorLOSS)
```
now adding feature selection to see if the model can improve with the table in it's present format
```{r}
full.mod <- glm(WINorLOSS~.,family = "binomial", data=cleandata)
step.mod <- full.mod %>% stepAIC(trace = FALSE)
summary(step.mod)

step.pred <- predict(step.mod, newdata = test, type = "response")
step.pred <- ifelse(step.pred>.5, "W", "L")
step.pred <- factor(step.pred, levels = c("W","L"))

cm.step <- confusionMatrix(data = step.pred, reference = test$WINorLOSS)
cm.step
```
The variable Game, probably does not make sense in the context of our dataset without an interaction. Since for any given game there are exactly the same number of wins and losses (each match has one winner and one loser).
We will therefore fit a new model without Game for our no interaction model, keeping in mind that there might be potential interactions between Game and other variables which might make for a better more complex model in Objective 2

```{r}
reduced.mod <- glm(WINorLOSS~ Home + PTS + FGA + `FG%` + `3P%` + FTA + `FT%` + TRB + AST + STL + BLK + TOV + PF, family = "binomial", data = train)
summary(reduced.mod)

reduced.pred <- predict(reduced.mod, newdata = test, type = "response")
reduced.pred <- ifelse(reduced.pred>.5, "W", "L")
reduced.pred <- factor(reduced.pred, levels = c("W","L"))

cm.reduced <- confusionMatrix(reduced.pred, test$WINorLOSS)
cm.reduced
```
Finally, we will now use LASSO for selection to compare to the simple 
```{r}
train.x <- model.matrix(WINorLOSS~.-1, data = train) #-1 removes intercept column
train.y <- train[,1]

cvfit <- cv.glmnet(train.x, train.y, family = "binomial", type.measure = "class")
plot(cvfit)

coef(cvfit, s= "lambda.min")
cvfit$lambda.min # this is the optimal LASSO penalty value

lasso.mod <- glmnet(train.x, train.y, family = "binomial", lambda = cvfit$lambda.min)
summary(lasso.mod)

print(lasso.mod)

test.x <- model.matrix(WINorLOSS~.-1, data = test)
lasso.pred <- predict(lasso.mod, newx = test.x, type = "response")
lasso.pred <- ifelse(lasso.pred>.5, "W", "L")
lasso.pred <- factor(lasso.pred, levels = c("W","L"))

cm.lasso <- confusionMatrix(data = lasso.pred, reference = test$WINorLOSS)
cm.lasso
```
Create a table with the results from all the confusion Matrix models
```{r}
cm.df <- data.frame("Model" = c("Simple", "Stepwise", "Reduced", "LASSO"),
           "Accuracy"= c(cm.simple$overall[1], cm.step$overall[1], cm.reduced$overall[1],cm.lasso$overall[1]),
           "Sensitivity"=c(cm.simple$byClass[1], cm.step$byClass[1],cm.reduced$byClass[1], cm.lasso$byClass[1]),
           "Specificty" = c(cm.simple$byClass[2], cm.step$byClass[2], cm.reduced$byClass[2], cm.lasso$byClass[2]))
cm.df <- kable(cm.df, format = "html") %>% kable_styling(latex_options = c("striped", "scale_down"), full_width = FALSE) %>% 
  row_spec(row = 0, italic = T, background = "#21918c", color = "white") %>% 
  column_spec(1:2, width = "0.5in")
cm.df
```

